% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/prob_posthoc.R
\name{primo_pipeline_wrap}
\alias{primo_pipeline_wrap}
\title{PRIMO-based cell-type pattern classification with FDR filtering}
\usage{
primo_pipeline_wrap(
  merged,
  pvals_names,
  p_join_name,
  type_col = "type_ct2",
  fdr_cutoff = 0.1,
  specific_label = "CellTypeSpecific",
  unspecific_label = "NonSpecific",
  ...
)
}
\arguments{
\item{merged}{A data.frame containing marginal p-values, joint p-values,
and a column indicating whether each gene is cell-type-specific or
non-specific.}

\item{pvals_names}{Character vector of column names for marginal p-values,
one per cell type (length \eqn{K}).}

\item{p_join_name}{Character. Column name for the joint (non-specific)
p-value.}

\item{type_col}{Character. Column indicating specificity labels.}

\item{fdr_cutoff}{Numeric. FDR threshold for declaring significance
(default 0.1).}

\item{specific_label}{Character. Label identifying cell-type-specific rows.}

\item{unspecific_label}{Character. Label identifying non-specific rows.}

\item{...}{Additional arguments passed to \code{Primo::Primo_pval()}.}
}
\value{
A list with the following elements:
\describe{
\item{out}{Original data.frame augmented with BH-adjusted p-values,
PRIMO posterior probabilities (\code{post_*}), and MAP pattern labels.}
\item{alt_props_used}{Prior non-null proportion used in PRIMO.}
\item{sig_gene_percentage}{Estimated fraction of genes with marginal
association signal.}
\item{sig_spec_idx}{Indices of significant cell-type-specific genes.}
\item{sig_uns_idx}{Indices of significant non-specific genes.}
\item{tab_specific_patterns}{Table of MAP pattern counts among significant
cell-type-specific genes.}
\item{n_trait}{Named vector giving counts of genes uniquely associated
with each cell type.}
\item{n_shared_specific}{Number of significant cell-type-specific genes
associated with two or more cell types.}
\item{n_shared_nonspecific}{Number of significant non-specific genes.}
\item{n_shared_total}{Total number of shared genes.}
\item{post_colnames}{Names of PRIMO posterior probability columns.}
}
}
\description{
This function implements the complete PRIMO-based classification pipeline
used in S-MiXcan analyses. Marginal and joint p-values are first adjusted
using the Benjamini--Hochberg procedure. Genes labeled as cell-type-specific
are evaluated using marginal FDR (OR rule across cell types) and subsequently
classified into cell-type association patterns using PRIMO posterior
probabilities. Genes labeled as non-specific are evaluated using the fdr
test only and are not passed to PRIMO.
}
\details{
Importantly, PRIMO posterior probabilities are not modified. Maximum a
posteriori (MAP) classification is performed only among significant
cell-type-specific genes after conditioning on being non-null (i.e., excluding
the all-zero association pattern).

The function supports an arbitrary number of cell types (\eqn{K}) and
preserves PRIMO's native association-pattern ordering using
\code{Primo::make_qmat()}.

The prior non-null proportion supplied to PRIMO is estimated as
\deqn{\Pr(\text{any marginal FDR} < \alpha) / K,}
where \eqn{K} is the number of cell types and \eqn{\alpha} is the FDR cutoff.

For MAP classification, posterior probabilities are renormalized over all
non-null patterns (excluding the all-zero pattern) and the most likely
pattern is selected.
}
\examples{
\dontrun{
res <- primo_pipeline_wrap(
  merged,
  pvals_names = c("p_1_ct2", "p_2_ct2"),
  p_join_name = "p_join_ct2",
  type_col = "type_ct2"
)

res$n_shared_total
table(res$out$MAP_pattern_nonnull)
}

}
\seealso{
\code{\link[Primo]{Primo_pval}}, \code{\link[Primo]{make_qmat}}
}
